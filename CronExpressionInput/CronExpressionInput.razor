@using System.Linq
@using System.Linq.Expressions
@using Radzen
@using Radzen.Blazor

<div class="cron-expression-input @Class">
    <label class="cron-label">Cron expression</label>
    <div class="cron-expression-row">
        <RadzenTextBox Name="CronExpression"
                       class="cron-expression"
                       Value="@CurrentValue"
                       Change="OnExpressionInput"
                       Disabled="@Disabled" />
        <RadzenButton Icon="edit"
                      ButtonStyle="ButtonStyle.Primary"
                      class="cron-open"
                      Disabled="@Disabled"
                      Click="OpenDialog" />
    </div>
</div>

@code {
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    [Parameter] public Expression<Func<string?>>? ValueExpression { get; set; }

    [Parameter] public bool ShowSeconds { get; set; }
    [Parameter] public bool IncludeYear { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string? Class { get; set; }

    [Inject] public DialogService DialogService { get; set; } = default!;

    private string? _lastValue;
    private string[] _fieldValues = Array.Empty<string>();

    private string CurrentValue => Value ?? string.Empty;

    protected override void OnParametersSet()
    {
        if (_lastValue != Value)
        {
            ParseValueIntoFields(Value);
            _lastValue = Value;
        }
    }

    private void EnsureFieldValues()
    {
        var expected = GetExpectedFieldCount();
        if (_fieldValues.Length != expected)
        {
            _fieldValues = Enumerable.Repeat("*", expected).ToArray();
        }
    }

    private int GetExpectedFieldCount()
    {
        var count = 5; // min hour day month day-of-week
        if (ShowSeconds) count++;
        if (IncludeYear) count++;
        return count;
    }

    private void ParseValueIntoFields(string? expression)
    {
        EnsureFieldValues();

        if (string.IsNullOrWhiteSpace(expression))
        {
            _fieldValues = Enumerable.Repeat("*", _fieldValues.Length).ToArray();
            return;
        }

        var parts = expression.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        var expected = GetExpectedFieldCount();

        for (var i = 0; i < expected; i++)
        {
            _fieldValues[i] = i < parts.Length ? parts[i] : "*";
        }
    }

    private async Task OnExpressionInput(object? value)
    {
        if (Disabled) return;

        var text = value?.ToString() ?? string.Empty;
        _lastValue = text;
        ParseValueIntoFields(text);
        await ValueChanged.InvokeAsync(text);
    }

    private async Task OpenDialog()
    {
        if (Disabled) return;

        var parameters = new Dictionary<string, object>
        {
            { nameof(CronExpressionDialog.Value), CurrentValue },
            { nameof(CronExpressionDialog.ShowSeconds), ShowSeconds },
            { nameof(CronExpressionDialog.IncludeYear), IncludeYear }
        };

        var result = await DialogService.OpenAsync<CronExpressionDialog>(
            "Cron expression",
            parameters,
            new DialogOptions { Width = "900px", Height = "auto", Resizable = true, Draggable = true });

        if (result is string updated)
        {
            _lastValue = updated;
            ParseValueIntoFields(updated);
            await ValueChanged.InvokeAsync(updated);
        }
    }
}
